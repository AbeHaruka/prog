<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="chat.css">
    <title>リアルタイムチャット</title>
  </head>

  <body>

    <div>
      <div> Name：<input type="text" id="uname" placeholder="名前を入力"> </div>
      <div id="okuru">
        <textarea id="text" cols="75" rows="2"  placeholder="メッセージを入力" ></textarea>
        <input type="button" id="send" value="送信" />
      </div>
      <div id="output" style="overflow:auto; height: 350px;"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <script type="module">

      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
      import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved } 
      from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA7poXxNQsYWrVDcyHf6a35gksn6IJGnwE",
        authDomain: "sample-af28e.firebaseapp.com",
        databaseURL: "https://sample-af28e-default-rtdb.firebaseio.com",
        projectId: "sample-af28e",
        storageBucket: "sample-af28e.appspot.com",
        messagingSenderId: "73759018215",
        appId: "1:73759018215:web:79a676d951e76baa152642"
      };

      
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const dbRef = ref(db,"chat");


      //送信クリックイベント
      $("#send").on("click",function(){

        
        const msg = {
          uname : $("#uname").val(),
          text : $("#text").val(),
          a : now()
        }

        const newPostRef = push(dbRef);
        console.log(newPostRef);
        set(newPostRef,msg,);

        $("#text").val("");
      
      });

      //エンターキーイベント
      $("#text").keydown(function(){

        if(event.key ==="Enter"){
          const msg = {
          uname : $("#uname").val(),
          text : $("#text").val(),
          a : now()
        }

        const newPostRef = push(dbRef);
        console.log(newPostRef);
        set(newPostRef,msg,);

        $("#text").val("");
      

        }
         
      });

      //現在日時取得関数
      function now(){
        const now = new Date(); //日時
        const month = now.getMonth() + 1; 
        const date = now.getDate();
        const hour = now.getHours();
        const m = now.getMinutes();

        const ima = ("("+month+"/"+date+"/"+hour+":"+m+")");
        return(ima);
      }

      onChildAdded(dbRef,function(data){
        const msg =data.val();
        const key = data.key;

        let h ='<p>';
            h+='【';
            h+=msg.uname;
            h+='】';
            h+=msg.text;
            h+='<font size="1">'+msg.a+'</font>';
            h+='<br>';
            h+='</p>';
            $("#output").append(h);
      });

  </script>

  </body>
</html>